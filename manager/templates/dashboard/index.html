{% extends 'base.html' %}

{# --------------------------------------------------------------------------
                                                              EXTRA CSS, JS
-------------------------------------------------------------------------- #}

{% block extra %}
  <script src="{{ url_for('static', filename='misc.js') }}"></script>
{% endblock %}

{# --------------------------------------------------------------------------
                                                                  SCRIPTAGE
-------------------------------------------------------------------------- #}

{% block scriptage %}
  <script>
// this is used for finding the burst actions on submit
var burst_states;
var burst_updates;

// translation lookup map.  This is to make the text available to library
// code that doesn't get parsed as templates.
var i18n_texts = {
  "Cancel": "{{ _('Cancel') }}",
  "Update": "{{ _('Update') }}"
};


$("#notification").hide();
$("#error").hide();
$("#error").click(function(e) {
  $("#error").hide();
});

function refresh_bursts() {
  $.ajax({
    url: '/xhr/bursts/',
    method: 'GET',
    success: display_bursts,
    error: function() {
      flash_error("refresh_bursts() AJAX error")
    }
  });
}

function epoch_to_local_time(epoch) {
  // epochs in Javascript are milliseconds but we're using seconds
  var d = new Date(epoch * 1000);
  return(d.toLocaleString());
}

function display_bursts(reports, status, jqXHR) {

  // reset burst IDs array
  burst_states = {};
  burst_updates = {};

  // used to track clusters
  var clusters = [];

  // burst reports are organized by cluster
  if (Object.keys(reports).length > 0) {

    // get main accordion container
    var accordionParent = document.getElementById('bursts_accordion');

    for (var cluster in reports) {

      clusters.push(cluster);

      // TODO: i18n
      var title = `${cluster} - reported ${epoch_to_local_time(reports[cluster]['epoch'])}`;

      // create accordian for this
      var accordion = document.createElement('div');
      accordion.innerHTML = `<div class="accordion-item">
        <h2 class="accordion-header" id="heading-${cluster}">
          <button id="collapse-button-${cluster}" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${cluster}" aria-expanded="false" aria-controls="collapse-${cluster}">
            ${title}
          </button>
        </h2>
        <div id="collapse-${cluster}" class="accordion-collapse collapse" aria-labelledby="heading-${cluster}" data-bs-parent="#bursts_accordion">
          <div class="accordion-body">
            <table id='bursts_table_${cluster}' class='' style='width: 100%'>
              <thead>
                <tr>
                  <th                        >Occ</th>
                  <th                        >{{ _('Account') }}</th>
                  <th class='nosearch nosort'>{{ _('Usage') }}</th>
                  <th                        >{{ _('Pain') }}</th>
                  <th class='nosort'         >{{ _('Summary') }}</th>
                  <th                        >{{ _('State') }}</th>
                  <th                        >{{ _('Ticket') }}</th>
                  <th class='nosearch nosort'>{{ _('Action') }}</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>`;

      // add to parent and so to the DOM
      accordionParent.appendChild(accordion);

      // create the table
      $(`#bursts_table_${cluster}`).dataTable({
        "autoWidth": false,
        "data": renderTableData(reports[cluster]['bursts']),
        "columnDefs": [
          { searchable: false, targets: 'nosearch' },
          { orderable: false, targets: 'nosort' }
        ],
        }
      );
    }

    // determine which cluster should be expanded by default
    var expand_cluster = Cookies.get("default-cluster");
    if (!expand_cluster || !(expand_cluster in clusters)) {
      expand_cluster = clusters[0];
      Cookies.set("default_cluster", expand_cluster);
    }

    // expand that cluster's accordion
    // There are two ways to do this: send a button-click message to the
    // accordion button, or manipulate the classes of the accordion button
    // and the accordioned division.  The latter eliminates the animation,
    // which is too much fancy for a basic page load
    //$(`#collapse-button-${expand_cluster}`).click();
    $(`#collapse-button-${expand_cluster}`).removeClass('collapsed');
    $(`#collapse-${expand_cluster}`).addClass('show');

  } else {
    r = document.createElement("tr");
    r.innerHTML = "<td></td><td colspan=7>{{ _('There are currently no bursts defined.') }}</td>";
    tbody.appendChild(r);
  }

  var button = document.getElementById("submit_actions");
  button.innerHTML = "Update";
  button.disabled = true;
}

function updateSelection(id, new_state) {
  if (new_state == burst_states[id]) {
    delete burst_updates[id];
  }
  else {
    burst_updates[id] = new_state;
  }

  // determine update button label
  var label;
  var button = document.getElementById("submit_actions");
  var burst_update_count = Object.keys(burst_updates).length;
  if (burst_update_count == 0) {
    label = "{{ _('Update') }}";
    button.disabled = true;
    button.innerHTML = label;
  }
  else {
    label = "{{ _('Update') }}" + ` (${burst_update_count})`;
    button.disabled = false;
    button.innerHTML = label;
  }
}

function createTicket(id) {
  console.log("createTicket(" + id + ")");
}

// find first row in a table
function find_first_row(tbody_id) {
  var el = document.getElementById(tbody_id);
  if (el.nodeName == "TBODY") {
    el = el.firstElementChild;
    if (el.nodeName == "TR") {
      return(el);
    }
  }
  return null;
}

// iterate through burts
function* burstActionIterator() {
  var row = find_first_row("bursts_body");
  if (!row) {
    console.log("Could not find row.");
    console.log("TODO: should probably flash something");
  }
  while (row) {
    yield row;
    row = row.nextElementSibling;
  }
}

function numerical_part(id) {
  var re = /^[a-zA-Z]*_([0-9]+)$/
  return id.match(re)[1];
}

// Submit actions
function submit_actions() {
  // submit updates if there are any
  if (Object.keys(burst_updates).length > 0) {
    $.ajax({
      url: '/xhr/bursts/',
      data: JSON.stringify(burst_updates),
      contentType: 'application/json',
      method: 'PATCH',
      success: display_bursts,
      error: function() { console.error("submit_actions() AJAX error"); }
    });
  }
}

function flash_error(summary, message) {
  error_div = document.getElementById('error');
  error_div.innerHtml = "";

  title = document.createElement('h4');
  title.textContent = summary;
  content = document.createElement('p');
  content.textContent = message;

  error_div.appendChild(title);
  error_div.appendChild(content);
  error_div.style.display = "block";
}

// NOTIFICATIONS
// This mechanism adapted from 
// https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API/Using_the_Notifications_API

function handleNoNotifications(msg) {
  console.log("No notifications: " + msg);

  // show "refresh <stuff>" link
  var link = document.getElementById("refresh_content_link");
  link.style.display = "block";
}

function handlePermission(permission) {

  // make sure Chrome stores the information
  if (!('permission' in Notification)) {
    Notification.permission = permission;
  }

  if (Notification.permission === 'denied' || Notification.permission === 'default') {
    handleNoNotifications("Denied by user.");
  } else {
    // set up notifications listener
    var targetContainer = document.getElementById("notification");
    var eventSource = new EventSource("/notifications");

    eventSource.onmessage = function(e) {

      // "refresh" notification needs no other processing, just refresh
      if (e.data != "refresh") {
        // if window is in focus or notifications are disabled
        if (document.hasFocus() || Notification.permission != "granted") {
          // TODO: really mixing jQuery and vanilla JS here
          $("#notification").show();
          targetContainer.innerHTML = e.data;
        }
        else {
          var notification = new Notification(e.data)
          notification.onshow = function() { setTimeout(notification.close, 15000) }
        }
      }
      refresh_content();
    };
  }
}

function checkNotificationPromise() {
  try {
    Notification.requestPermission().then();
  } catch(e) {
    return false;
  }
  return true;
}

// set up notifications...
// first check if browser supports them
if (!('Notification' in window)) {
  handleNoNotifications("Browser does not suppoert");
} else {
  if (checkNotificationPromise()) {
    Notification.requestPermission().then((permission) => {
      handlePermission(permission);
    })
  } else {
    Notification.requestPermission(function(permission) {
      handlePermission(permission);
    });
  }
}

function jsonToTable(json) {
  var summary = JSON.parse(json);
  var summaryHTML = '';
  for (key in summary) {
    summaryHTML += `<tr><th>${key}</th><td>${summary[key]}</td></tr>`;
  }
  return `<table class='not-table'>${summaryHTML}</table>`;
  
}

function renderActionButtons(id, state_checked) {
  return `
    <label class='switch' title='{{ _("Unclaim") }}'>
      <input type='radio' name='moderation_${id}' class='grey'  id='defer_${ id }'  ${ state_checked["p"] } onClick='updateSelection(${ id }, "p")'>
        <span class='toggle'>&#x1f97a;</span>
      </input>
    </label>
    <label class='switch' title='{{ _("Claim this burst candidate for followup") }}'>
      <input type='radio' name='moderation_${id}' class='grey'  id='claim_${ id }'  ${ state_checked["c"] } onClick='updateSelection(${ id }, "c")'>
        <span class='toggle'>&#x1f914;</span>
      </input>
    </label>
    <label class='switch' title='{{ _("Promote this account for bursting") }}'>
      <input type='radio' name='moderation_${id}' class='green' id='accept_${ id }' ${ state_checked["a"] } onClick='updateSelection(${ id }, "a")'>
        <span class='toggle'>&#x1f600;</span>
      </input>
    </label>
    <label class='switch' title='{{ _("Do not promote this account for bursting") }}'>
      <input type='radio' name='moderation_${id}' class='red'   id='reject_${ id }' ${ state_checked["r"] } onClick='updateSelection(${ id }, "r")'>
        <span class='toggle'>&#x1f625;</span>
      </input>
    </label>
  `;
}

function renderTableData(bursts) {
  /* if this is used from the AJAX results, we get data like this:
    {
      "protocluster": {
        "bursts": [
          {
            "account": "def-raveeg1_cpu", 
            "claimant": null, 
            "cluster": "protocluster", 
            "epoch": 1614266800, 
            "id": 1, 
            "jobrange": [
              10000, 
              10500
            ], 
            "pain": 0.4, 
            "state": "p", 
            "state_pretty": "Unclaimed", 
            "summary": "{\"cpus_total\": 100, \"jobs_total\": 50, \"mem_total\": 200}", 
            "ticks": 0
          }
        ], 
        "epoch": 1614266800
      }
    }
  */
  burst_states = {};
  burst_updates = {};

  bycols = [];
  // ...but we don't get it like that no mo 
  //bursts = data.protocluster.bursts;
  for (var i=0, ien=bursts.length; i<ien; i++) {
    var state_checked = {}
    state_checked[bursts[i].state] = "checked='checked'";

    bycols[i] = [
      bursts[i].ticks,
      bursts[i].account,
      `<a target="beamplot" href="https://static.frak.c3.ca/usage-graphs/${bursts[i].account}_cumu_plot.html">Cumulative</a>
       <a target="beamplot" href="https://static.frak.c3.ca/usage-graphs/${bursts[i].account}_insta_plot.html">Instant</a>`,
      bursts[i].pain,
      jsonToTable(bursts[i].summary),
      bursts[i].state_pretty,
      "None",
      renderActionButtons(bursts[i].id, state_checked)
    ];
  }
  return bycols;
}

$(document).ready(function() {

  // load bursts
  refresh_bursts();

  // disable submit-actions button
  document.getElementById("submit_actions").disabled = true;
});
  </script>
{% endblock %}

{# --------------------------------------------------------------------------
                                                                     HEADER
-------------------------------------------------------------------------- #}

{% block header %}
  <h1>{% block title %}{{ _('Dashboard') }}{% endblock %}</h1>
{% endblock %}

{# --------------------------------------------------------------------------
                                                                    CONTENT
-------------------------------------------------------------------------- #}

{% block content %}
<div id='notification'>
</div>
<div id='error'>
</div>

<div class='accordion' id='bursts_accordion'>
</div>

<button id='submit_actions' value='Submit' onclick='submit_actions()'>{{ _('Update') }}</button>

{% endblock %}

