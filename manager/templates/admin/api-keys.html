{# --------------------------------------------------------------------------
                                                                      html
-------------------------------------------------------------------------- #}

<table id='api_keys' class='admin'>
  <thead>
    <tr>
      <th>Name</th>
      <th>Cluster</th>
      <th>Component</th>
      <th></th>
    </tr>
  </thead>
  <tbody id='api_keys_tbody'>
    <tr>
      <td colspan=3>{{ _('LOADING') }}</td>
      <td></td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <th colspan=3><a href='#' class='add_api_key' data-bs-toggle='modal' data-bs-target='#apikeyModal' data-i18n='CREATE_API_KEY'>Create new API key</a></th>
      <td></td>
    </tr>
  </tfoot>
</table>

{# ---------------------------------------------------------------------------
                                                                  scriptage
--------------------------------------------------------------------------- #}

<script>

  function trigger_create_api_key(form, modal) {
    formdata = get_form_values(form);
    console.log(formdata);
    create_api_key(formdata['apikey_name'], 'MAKE_UP_A_COMPONENT', formdata['apikey']);
    bootstrap.Modal.getInstance(modal).hide();
  }

  function create_api_key(name, component, secret) {
    var status_id = status(i18n('CREATING_API_KEY'));
    $.ajax({
      url: '/xhr/apikeys/',
      method: 'POST',
      data: {
        "apikey": secret,
        "apikey_name": name,
        "component": component
      },
      success: function() {
        load_api_keys();
        status_clear(status_id);
        return(true);
      },
      error: function() { 
        status_clear(status_id);
        error(i18n("CREATING_API_KEY_FAILED"));
        return(false);
      }
    });
  }

  function delete_api_key(id) {
    var status_id = status(i18n('DELETING_API_KEY'));
    $.ajax({
      url: '/xhr/apikeys/' + id,
      method: 'DELETE',
      success: function() {
        load_api_keys();
        status_clear(status_id);
      },
      error: function() {
        status_clear(status_id);
        error(i18n("DELETING_API_KEY_FAILED"));
      }
    });
  }

  function load_api_keys(event, ui) {
    $.ajax({
      url: '/xhr/apikeys/',
      method: 'GET',
      success: display_api_keys,
      error: function() { console.error("load_api_keys() AJAX error"); }
    });
  }

  function display_api_keys(apikeys, status, jqXHR) {

    // clear out body of table, leaving header and footer intact
    var tbody = document.getElementById("api_keys_tbody");
    tbody.innerHTML = "";

    // create row for each API key
    if (apikeys) {
      for (apikey of apikeys) {
        r = document.createElement("tr");
        r.innerHTML = `
          <td>${apikey['access']}</td>
          <td>${apikey['cluster']}</td>
          <td>${apikey['component']}</td>
          <td><a href='#' data-bs-toggle='modal' data-bs-target='#apikeyDeleteModal'
            data-delete_key='${apikey["access"]}'
            data-delete_key_cluster='${apikey["cluster"]}'
            data-delete_key_component='${apikey["component"]}'><img 
              class='delete_api_key' src='{{ url_for('static', filename='icons/remove.svg') }}' height=24 width=24></img></a></td>`;
        tbody.appendChild(r);
      }
      document.getElementById('apikeyDeleteModal').addEventListener("show.bs.modal", function(event) {
        document.getElementById('apikey-to-delete').innerHTML = event.relatedTarget.dataset.delete_key;
        document.getElementById('apikey-to-delete-cluster').innerHTML = event.relatedTarget.dataset.delete_key_cluster;
        document.getElementById('apikey-to-delete-component').innerHTML = event.relatedTarget.dataset.delete_key_component;
        document.getElementById('delete-api-key').addEventListener('click', function(clickevent) {
          delete_api_key(event.relatedTarget.dataset.delete_key);
          bootstrap.Modal.getInstance(document.getElementById('apikeyDeleteModal')).hide();
        });
      });
    } else {
      r = document.createElement("tr");
      r.innerHTML = "<td colspan=4>There are currently no API keys defined.</td>";
      tbody.appendChild(r);
    }

    /* ---- old jQueryUI stuff ----------------------------------------------
    // set up confirmation dialog box
    $("#confirm_delete_api_key").dialog({ autoOpen: false, modal: true });
    $(".delete_api_key").click(function(e) {
      $id = e.delegateTarget.id.split(':')[1];
      $("#delete_api_key").click(function() {
        delete_api_key($id);
        load_api_keys();
      });
      $("#confirm_delete_api_key").dialog('open');
      return(false);
    });
    ------- old jQueryUI stuff ------------------------------------------- */
  }

  window.addEventListener("load", function() {

    // load api keys
    load_api_keys();

    // when showing new key modal, generate new API key
    var apikeyModal = document.getElementById('apikeyModal');
    apikeyModal.addEventListener("show.bs.modal", function(event) {
      // reset form
      var modalForm = apikeyModal.querySelector('.modal-form');
      modalForm.reset();

      // populate key
      document.getElementById('apikey').value = generate_api_key();

      // populate components selector
      var status_id = status(i18n("RETRIEVING_COMPONENTS"));
      var componentsSel = $('#components-selection');
      componentsSel.empty();
      componentsSel.append(`<option selected disabled value=''>${i18n('SELECT_COMPONENT')}</option>`);
      $.ajax({
        url: '/xhr/components/',
        method: 'GET',
        success: function(components, status, jqXHR) {
          if (components) {
            for (component of components) {
              componentsSel.append(`<option value=${component['id']}>${component['name']} (${component['cluster']})</option>`);
            }
          }
          status_clear(status_id);
        },
        error: function() {
          status_clear(status_id);
          error(i18n("RETRIEVING_COMPONENTS_FAILED"));
        }
      });
      modalForm.onsubmit = function() {
        formdata = get_form_values(modalForm);
        console.log(formdata);
        create_api_key(formdata['apikey_name'], formdata['component'], formdata['apikey']);
        bootstrap.Modal.getInstance(apikeyModal).hide();

        // return false so we don't refresh page
        return false;
      };
    });

  });
</script>

{# ---------------------------------------------------------------------------
                                                     dialog: create API key
--------------------------------------------------------------------------- #}

<div class='modal fade' id='apikeyModal' tabindex='-1'> 
  <div class='modal-dialog modal-dialog-centered modal-lg'>
    <div class='modal-content'>
      <div class='modal-header'>
        <h5 class='modal-title' id='infoModalTitle' data-i18n='CREATE_API_KEY'>Create API key</h5>
        <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body' id='' data-i18n='CREATE_API_KEY_INFO'>
      </div>
      <form class='modal-form' id='create_api_key_form'>
      <div class='modal-body' id='api-key'>
        <table>
        <tr>
          <th data-i18n='NAME'>Name</th>
          <td><input
            id='apikey_name' type='text' maxlength=16 name='apikey_name'
            required pattern='^[a-zA-Z0-9_]+$'
          /> <span data-i18n='APIKEY_NAME_FORMAT'></span></td>
        </tr><tr>
          <th><label for='recipient' data-i18n='COMPONENT'>Component</label></th>
          <td>
            <select class='form-select' id='components-selection' name='component'>
              <option selected disabled value='' data-i18n='SELECT_COMPONENT'>Selekt komponent</option>
            </select>
          </td>
        </tr><tr>
          <th data-i18n='KEY'>Key</th>
          <td><input id='apikey' type='text' size='64' readonly name='apikey'
              style='font-size:smaller;font-family:monospace'/>
            <img src='{{ url_for('static', filename='icons/clipboard.svg') }}'
            height=24 width=24 onclick='copy_to_clipboard($("#apikey")[0])'/></td>
        </tr>
        </table>
      </div>
      <div class='modal-footer'>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n='CANCEL'>Cancel</button>
        <button type="submit" class="btn btn-primary" data-i18n='CREATE_API_KEY'>Create API Key</button>
      </div>
      </form>
    </div>
  </div>
</div>

{# ---------------------------------------------------------------------------
                                             dialog: confirm delete API key
--------------------------------------------------------------------------- #}

<div class='modal fade' id='apikeyDeleteModal' tabindex='-1'> 
  <div class='modal-dialog modal-dialog-centered'>
    <div class='modal-content'>
      <div class='modal-header'>
        <h5 class='modal-title' id='infoModalTitle' data-i18n='DELETE_API_KEY'>Delete API key</h5>
        <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body' id='' data-i18n='DELETE_API_KEY_INFO'>
      </div>
      <div class='modal-body'>
        <table>
          <tr><th data-i18n='KEY'></th><td id='apikey-to-delete'></td></tr>
          <tr><th data-i18n='CLUSTER'></th><td id='apikey-to-delete-cluster'></td></tr>
          <tr><th data-i18n='COMPONENT'></th><td id='apikey-to-delete-component'></td></tr>
        </table>
      </div>
      <div class='modal-footer'>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n='CANCEL'>Cancel</button>
        <button type="button" class="btn btn-primary" id='delete-api-key' data-i18n='DELETE_API_KEY'>Delete API Key</button>
      </div>
    </div>
  </div>
</div>
